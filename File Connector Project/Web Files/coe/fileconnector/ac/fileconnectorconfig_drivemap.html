<!--
	© 2007 Cordys R&D B.V. All rights reserved.
	The computer program(s) is the proprietary information of Cordys R&D B.V. 
	and provided under the relevant License Agreement containing restrictions 
	on use and disclosure. Use is subject to the License Agreement.
-->
<html xmlns:eibus onselect="onAppSelect()" onbeforeapplicationclose="onAppClose()">
    <head>
        <script src="/cordys/wcp/application.js"></script>
        <script src="common.js"></script>
        <title>Drive Mappings Configuration</title>
    </head>
    <script>
        /**
    	 * Indicates whether the page is loaded completely.
    	 */
    	var pageInitialized = false; 
    	/**
    	 * Contains data passed from the parent page. This page regiters
    	 * callback methods for it.
    	 */
    	var parentPageData;
    	/**
    	 * Contains the base 64 encoder library.
    	 */
    	var base64encoderLib;
    
            /**
         * Called when this page is selected by application.select()
         */
        function onAppSelect()
        {
        	if (! base64encoderLib) {
        		base64encoderLib = new Object();
        		application.addLibrary("/cordys/wcp/admin/library/base64encoder.htm", base64encoderLib);
        	}
        
			if (application.event && application.event.data) {
        		parentPageData = application.event.data;
        		parentPageData.isPageLoaded = isPageLoaded;
        		parentPageData.createConnectorConfiguration = createConnectorConfiguration;
        		parentPageData.fillInPropertyScreen = fillInPropertyScreen;
			}
			
			pageInitialized = true;
        }
        
      	/**
         * Cleans up the page.
         */
        function onAppClose()
        {
        	if (base64encoderLib) {
    	    	application.removeLibrary("/cordys/wcp/admin/library/base64encoder.htm", base64encoderLib);	
        		base64encoderLib = null;
        	}
        }
        
        /**
         * Returns true if the pages has been completely loaded.
         */
        function isPageLoaded()
        {
        	return pageInitialized;
        }

        /**
         * This method creates the needed configuration for the connector
         *
         * @param nConfig The configuration-XML.
         */
        function createConnectorConfiguration(nConfig)
        {
            var bReturn = true;
            var xmlDoc = nConfig.ownerDocument;

	        //Get all the rows.
			var nAttrBase = xmlDoc.createElement("drivemappings");
			nConfig.appendChild(nAttrBase);
			
			var aRows = tbProps.all("trHasBeenCloned");
			if (aRows != null)
            {
			    if (typeof(aRows.length) == "undefined")
    			{
    				//Only 1 row. Convert it into an array.
                    var oTemp = aRows;
                    aRows = new Array();
                    aRows[0] = oTemp;
                }
			
                for (var iCount = 0; iCount < aRows.length; iCount++)
                {
                    var oLocation = aRows[iCount].all("txtLocation");
                    var oDriveLetter = aRows[iCount].all("txtDriveLetter");
                    var oUsername = aRows[iCount].all("txtUsername");
                    var oPassword = aRows[iCount].all("txtPassword");
                    if (oLocation.value.length > 0)
                    {
                       var nAttr = xmlDoc.createElement("drivemapping");
                       var nTemp = xmlDoc.createElement("location");
                       nTemp.text = oLocation.value;
                       nAttr.appendChild(nTemp);
                            
                       nTemp = xmlDoc.createElement("driveletter");
                       nTemp.text = oDriveLetter.value;
                       nAttr.appendChild(nTemp);
                            
                       nTemp = xmlDoc.createElement("username");
                       nTemp.text = oUsername.value;
                       nAttr.appendChild(nTemp);
                            
                       nTemp = xmlDoc.createElement("password");
                       nTemp.text = encode(oPassword.value);
                       nAttr.appendChild(nTemp);
                            
                       nAttrBase.appendChild(nAttr);
                    }
                }
            }
            
            return bReturn;
        }//createConnectorConfiguration
        
        /**
         * This method fills the inputfields based on the XML
         *
         * @param xmlConfig The configuration-XML.
         */
        function fillInPropertyScreen(xmlConfig)
        {   
	        var anNodes = xmlConfig.selectNodes(".//drivemappings/drivemapping");
			for (var iCount = 0; iCount < anNodes.length; iCount++)
			{
				var sLocation = anNodes[iCount].selectSingleNode(".//location").text;
				var sDriveLetter = anNodes[iCount].selectSingleNode(".//driveletter").text;
                var sUsername = anNodes[iCount].selectSingleNode(".//username").text;
                var sPassword = decode(anNodes[iCount].selectSingleNode(".//password").text);
				addProperty(sLocation, sDriveLetter, sUsername, sPassword);
			}
        }

     	/**
		 * This function adds a new line in the table so a property can be added.
		 */
		function newMapping()
		{
			addProperty("", "", "", "");
		}
		
		/**
		 * This function adds a property with the given name and value to the HTML table.
		 *
		 * @param sName The name of the property.
		 * @param sValue The value of the property.
		 */
		function addProperty(sLocation, sDriveLetter, sUsername, sPassword)
		{
			var oCloned = trCloned.cloneNode(true);
			tbProps.appendChild(oCloned);
			oCloned.style.display = "";
			oCloned.all("txtLocation").value = sLocation;
			oCloned.all("txtDriveLetter").value = sDriveLetter;
			oCloned.all("txtUsername").value = sUsername;
			oCloned.all("txtPassword").value = sPassword;
            oCloned.id = "trHasBeenCloned";
        }

        /**
		 * This function deletes all the selected properties.
		 */
		function deleteMappings()
		{
			//Get all the check-boxes
			var aToBeDeleted = new Array();
			
			var aRows = tbProps.all("txtChecked");
			if (typeof(aRows.length) == "undefined")
			{
				//Only 1 row. Convert it into an array.
				var oTemp = aRows;
				aRows = new Array();
				aRows[0] = oTemp;
			}
			
			//Check if the row is selected
			for (var iCount = 0; iCount < aRows.length; iCount++)
			{
				var oTmp = aRows[iCount];
				if (oTmp.checked == true)
				{
					aToBeDeleted[aToBeDeleted.length] = getTRParent(oTmp);
				}
			}
			
			for (var iCount = 0; iCount < aToBeDeleted.length; iCount++)
			{
				aToBeDeleted[iCount].parentNode.removeChild(aToBeDeleted[iCount]);
			}
        }

        /**
         * This method returns the first TR that is found going up in the tree. If no 
         * TR-element is found null is returned.
         *
         * @param htmlObj The HTML-object to start the search.
         *
         * @return The first ancestor in the tree that is a TR-tag.
         */
        function getTRParent(htmlObj)
        {
            return getTagParent(htmlObj, "TR");
        }//getTRParent

        /**
         * This method returns the first parent of htmlObj who's tagname is sTagname. If no 
         * parent is found with sTagname null is returned.
         *
         * @param htmlObj The HTML-object to start the search.
         *
         * @return The first ancestor in the tree that is a TR-tag.
         */
        function getTagParent(htmlObj, sTagname)
        {
            var oReturn = null;
            
            var currElement = htmlObj.parentElement;
            while (currElement != null)
            {
                if (("" + currElement.tagName).toUpperCase() == sTagname.toUpperCase())
                {
                    oReturn = currElement;
                    break;
                }
                currElement = currElement.parentElement;
            }
            
            return oReturn;
        }//getTRParent

        /**
         * Encode a password
         */     
        function encode(value)
        {
            return base64encoderLib.encode(value);
        }

        /**
         * Deccode a password
         */     
        function decode(value)
        {
            return base64encoderLib.decode(value);
        }
    </script>
    <body>
		<table width="100%" style="border: 1px solid black;" cellspacing="0" cellpadding="5">
			<thead>
    			<tr class="medium">
    				<td colspan="5">
    					<strong>Drivemappings to make</strong>
    				</td>
    			</tr>
				<tr class="medium">
					<td width="10%">
						<input type="image" src="/cordys/wcp/images/delete.gif" onclick="deleteMappings()"/>
						<input type="image" src="/cordys/wcp/images/new.gif" onclick="newMapping()"/>
					</td>
					<td width="40%">
						Share location
					</td>
					<td width="10%">
						Drive
					</td>
					<td width="15%">
						Username
					</td>
					<td width="15%">
						Password
					</td>
				</tr>
			</thead>
			<tbody id="tbProps">
				<tr id="trCloned" style="display:none">
					<td>
						<input type="checkbox" id="txtChecked"/> 
					</td>
					<td>
						<input type="text" class="input" id="txtLocation" style="width:100%">
					</td>
					<td>
                            <input type="text" class="input" id="txtDriveLetter" style="width:100%" maxlength="2" size="2">
					</td>
					<td>
						<input type="text" class="input" id="txtUsername" style="width:100%">
					</td>
					<td>
						<input type="password" class="input" id="txtPassword" style="width:100%">
					</td>
				</tr>
			</tbody>
        </table>
    </body>
</html>
